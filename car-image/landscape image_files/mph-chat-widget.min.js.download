/*! MPH Chat Widget v1.0.0 | Build: 2025-04-21T19:07:16.616Z | MIT License */
!function(){const n={apiUrl:"https://chat.mph.com",position:"bottom-right",showButton:!0,allowedOrigins:[],debug:!0,containerClass:"mph-chat-widget-container",title:"Miles the Car Concierge",animationsEnabled:!0,theme:{primary:"#000000",secondary:"#FFFFFF",text:"#333333",background:"#ffffff",inputBackground:"#f9f9f9",headerText:"#ffffff"}};function e(e,...t){n.debug&&console.log(`[MPH Chat Widget] ${e}`,...t)}function t(n){return"https:"===window.location.protocol&&n.startsWith("http:")?n.replace("http:","https:"):n}function a(n){return window.location.hostname.includes(".replit.dev")||window.location.hostname.includes(".repl.co")||window.location.hostname.includes(".replit.app")?(e("Replit environment detected, ensuring API URL compatibility"),n===window.location.origin?n:t(n)):t(n)}function o(){!function(){const e=document.getElementsByTagName("script"),t=e[e.length-1];if(t){if(t.dataset.apiUrl&&(n.apiUrl=t.dataset.apiUrl),t.dataset.position&&(n.position=t.dataset.position),void 0!==t.dataset.showButton&&(n.showButton="false"!==t.dataset.showButton),void 0!==t.dataset.debug&&(n.debug="true"===t.dataset.debug),t.dataset.containerClass&&(n.containerClass=t.dataset.containerClass),t.dataset.allowedOrigins)try{n.allowedOrigins=JSON.parse(t.dataset.allowedOrigins)}catch(n){console.error("Invalid allowedOrigins format. Expected JSON array.")}t.dataset.title&&(n.title=t.dataset.title),void 0!==t.dataset.animationsEnabled&&(n.animationsEnabled="false"!==t.dataset.animationsEnabled),t.dataset.primaryColor&&(n.theme.primary=t.dataset.primaryColor),t.dataset.secondaryColor&&(n.theme.secondary=t.dataset.secondaryColor),t.dataset.textColor&&(n.theme.text=t.dataset.textColor),t.dataset.backgroundColor&&(n.theme.background=t.dataset.backgroundColor),t.dataset.inputBackgroundColor&&(n.theme.inputBackground=t.dataset.inputBackgroundColor),t.dataset.headerTextColor&&(n.theme.headerText=t.dataset.headerTextColor)}}(),n.apiUrl=a(n.apiUrl),e("Widget configuration:",n);const t=document.createElement("style");t.textContent=`\n      .mph-chat-widget-container {\n        position: fixed;\n        z-index: 10000;\n        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n      }\n      \n      .mph-chat-widget-container.bottom-right {\n        bottom: 20px;\n        right: 20px;\n      }\n      \n      .mph-chat-widget-container.bottom-left {\n        bottom: 20px;\n        left: 20px;\n      }\n      \n      .mph-chat-widget-container.top-right {\n        top: 20px;\n        right: 20px;\n      }\n      \n      .mph-chat-widget-container.top-left {\n        top: 20px;\n        left: 20px;\n      }\n      \n      .mph-chat-button {\n        background-color: ${n.theme.primary};\n        color: white;\n        width: 60px;\n        height: 60px;\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        box-shadow: 0 4px 8px rgba(0,0,0,0.2);\n        border: none;\n        transition: transform 0.2s ease;\n      }\n      \n      .mph-chat-button:hover {\n        transform: scale(1.05);\n      }\n      \n      .mph-chat-window {\n        position: fixed;\n        width: 330px;\n        height: 500px;\n        background: ${n.theme.background};\n        border-radius: 10px;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n        border: 1px solid #ddd;\n        transition: opacity 0.3s ease, transform 0.3s ease;\n        opacity: 0;\n        transform: translateY(10px);\n        pointer-events: none;\n        box-sizing: border-box;\n      }\n      \n      .mph-chat-window.open {\n        opacity: 1;\n        transform: translateY(0);\n        pointer-events: all;\n      }\n      \n      .mph-chat-window.bottom-right {\n        bottom: 90px;\n        right: 20px;\n      }\n      \n      .mph-chat-window.bottom-left {\n        bottom: 90px;\n        left: 20px;\n      }\n      \n      .mph-chat-window.top-right {\n        top: 90px;\n        right: 20px;\n      }\n      \n      .mph-chat-window.top-left {\n        top: 90px;\n        left: 20px;\n      }\n      \n      .mph-chat-header {\n        background-color: ${n.theme.primary};\n        color: ${n.theme.headerText||"white"};\n        padding: 15px;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n      }\n      \n      .mph-chat-title {\n        margin: 0;\n        font-size: 16px;\n        font-weight: 600;\n        color: ${n.theme.headerText||"white"};\n      }\n      \n      .mph-close-button {\n        background: none;\n        border: none;\n        color: ${n.theme.headerText||"white"};\n        cursor: pointer;\n        font-size: 18px;\n        padding: 0;\n        margin: 0;\n        width: 24px;\n        height: 24px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n      \n      .mph-messages-container {\n        flex: 1;\n        overflow-y: auto;\n        overflow-x: hidden;\n        padding: 12px;\n        display: flex;\n        flex-direction: column;\n        width: 100%;\n        box-sizing: border-box;\n      }\n      \n      .mph-message {\n        margin: 8px 0;\n        padding: 10px;\n        border-radius: 8px;\n        max-width: 80%;\n        width: fit-content;\n        word-wrap: break-word;\n        overflow-wrap: break-word;\n      }\n      \n      .mph-user-message {\n        background-color: ${n.theme.primary};\n        color: white;\n        align-self: flex-end;\n      }\n      \n      .mph-assistant-message {\n        background-color: ${n.theme.inputBackground};\n        color: ${n.theme.text};\n        align-self: flex-start;\n      }\n      \n      .mph-input-area {\n        padding: 10px;\n        border-top: 1px solid #ddd;\n        display: flex;\n      }\n      \n      .mph-message-input {\n        flex: 1;\n        padding: 10px;\n        border: 1px solid #ddd;\n        border-radius: 4px;\n        margin-right: 10px;\n        background-color: ${n.theme.inputBackground};\n        color: ${n.theme.text};\n        outline: none;\n      }\n      \n      .mph-send-button {\n        background-color: ${n.theme.primary};\n        color: white;\n        border: none;\n        padding: 0 15px;\n        border-radius: 4px;\n        cursor: pointer;\n      }\n      \n      .mph-typing-indicator {\n        display: inline-block;\n        padding: 8px 15px;\n        background-color: ${n.theme.inputBackground};\n        border-radius: 15px;\n        margin-top: 5px;\n        align-self: flex-start;\n      }\n      \n      .mph-typing-indicator span {\n        width: 8px;\n        height: 8px;\n        background-color: #888;\n        display: inline-block;\n        border-radius: 50%;\n        margin: 0 2px;\n        opacity: 0.4;\n        animation: mph-typing 1.5s infinite;\n      }\n      \n      .mph-typing-indicator span:nth-child(2) {\n        animation-delay: 0.2s;\n      }\n      \n      .mph-typing-indicator span:nth-child(3) {\n        animation-delay: 0.4s;\n      }\n      \n      @keyframes mph-typing {\n        0%, 100% { opacity: 0.4; }\n        50% { opacity: 1; }\n      }\n      \n      /* Car result styles */\n      .mph-car-result {\n        background-color: white;\n        border-radius: 8px;\n        box-shadow: 0 2px 5px rgba(0,0,0,0.1);\n        margin: 10px 0;\n        padding: 10px;\n        width: 100%;\n        max-width: 95%;\n        border: 1px solid #ddd;\n        transition: box-shadow 0.2s ease;\n        overflow: hidden;\n        box-sizing: border-box;\n      }\n      \n      .mph-car-result:hover {\n        box-shadow: 0 4px 8px rgba(0,0,0,0.15);\n      }\n      \n      .mph-car-result-flex {\n        display: flex;\n        justify-content: space-between;\n        align-items: flex-start;\n        width: 100%;\n        box-sizing: border-box;\n      }\n      \n      .mph-car-result-content {\n        flex: 1;\n        min-width: 0;\n        padding-right: 8px;\n      }\n      \n      .mph-car-result-header {\n        font-weight: 500;\n        font-size: 14px;\n        margin-bottom: 4px;\n        color: #333;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n      \n      .mph-car-result-price {\n        font-weight: 600;\n        color: #333;\n        font-size: 14px;\n      }\n      \n      .mph-car-result-mileage {\n        font-size: 12px;\n        color: #555;\n        margin-left: 5px;\n      }\n      \n      .mph-car-result-details {\n        display: flex;\n        flex-direction: column;\n        font-size: 12px;\n        color: #666;\n        margin-top: 5px;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n\n      .mph-car-result-extras {\n        margin-top: 2px;\n        font-size: 11px;\n        color: #777;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n      \n      .mph-car-result-location {\n        font-size: 11px;\n        color: #777;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n      \n      .mph-car-result-image {\n        width: 55px;\n        height: 42px;\n        border-radius: 4px;\n        background-color: #f5f5f5;\n        overflow: hidden;\n        margin-left: 5px;\n        flex-shrink: 0;\n      }\n      \n      .mph-car-result-image img {\n        width: 100%;\n        height: 100%;\n        object-fit: cover;\n      }\n      \n      .mph-car-result-link {\n        display: flex;\n        text-align: right;\n        color: ${n.theme.primary};\n        text-decoration: none;\n        font-size: 12px;\n        margin-top: 8px;\n        padding-right: 2px;\n        align-items: center;\n        justify-content: flex-end;\n      }\n      \n      .mph-car-result-link svg {\n        width: 12px;\n        height: 12px;\n        margin-left: 4px;\n      }\n      \n      /* Responsive adjustments */\n      @media (max-width: 480px) {\n        .mph-chat-window {\n          width: 100%;\n          height: 100%;\n          bottom: 0 !important;\n          right: 0 !important;\n          left: 0 !important;\n          top: 0 !important;\n          border-radius: 0;\n        }\n      }\n    `,document.head.appendChild(t);const o=document.createElement("div");let i;o.className=`${n.containerClass} ${n.position}`,document.body.appendChild(o),n.showButton&&(i=document.createElement("button"),i.className="mph-chat-button",i.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',o.appendChild(i));const r=document.createElement("div");r.className=`mph-chat-window ${n.position}`;const s=document.createElement("div");s.className="mph-chat-header";const l=document.createElement("h3");l.className="mph-chat-title",l.textContent=n.title;const d=document.createElement("button");d.className="mph-close-button",d.innerHTML="&times;",s.appendChild(l),s.appendChild(d);const c=document.createElement("div");c.className="mph-messages-container";const p=document.createElement("div");p.className="mph-input-area";const h=document.createElement("input");h.className="mph-message-input",h.type="text",h.placeholder="Type your message...";const m=document.createElement("button");m.className="mph-send-button",m.textContent="Send",p.appendChild(h),p.appendChild(m),r.appendChild(s),r.appendChild(c),r.appendChild(p),o.appendChild(r);let g=!1,u=!1,f=null,w=null;function x(){e("openChat called, adding open class to chat window"),e("chat window before:",r.classList.contains("open")),r.offsetWidth,r.classList.add("open"),g=!0,e("chat window after:",r.classList.contains("open"));try{window!==window.parent&&window.parent.postMessage({action:"mph-chat-opened"},"*")}catch(n){e("Error posting message to parent:",n)}document.dispatchEvent(new CustomEvent("mph-chat-opened")),e("mph-chat-opened event dispatched"),f?e("Chat already initialized with contextId:",f):(e("No contextId, initializing chat"),C())}function y(){e("closeChat called, removing open class from chat window"),e("chat window before:",r.classList.contains("open")),r.offsetWidth,r.classList.remove("open"),g=!1,e("chat window after:",r.classList.contains("open"));try{window!==window.parent&&window.parent.postMessage({action:"mph-chat-closed"},"*")}catch(n){e("Error posting message to parent:",n)}document.dispatchEvent(new CustomEvent("mph-chat-closed")),e("mph-chat-closed event dispatched")}function b(){e("toggleChat called, current state:",g?"open":"closed"),g?(e("Chat is open, calling closeChat()"),y()):(e("Chat is closed, calling openChat()"),x()),setTimeout((()=>{e("After toggle, new state:",g?"open":"closed"),e("Chat window classList:",r.classList)}),100)}function v(){u&&w&&(u=!1,w.remove(),w=null)}async function C(){try{const t=await fetch(`${n.apiUrl}/api/chat/initialize`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!t.ok)throw new Error(`API error: ${t.status}`);const a=await t.json();e("Chat initialized:",a),a.success&&a.contextId?(f=a.contextId,a.welcomeMessage?k("assistant",a.welcomeMessage):k("assistant","Hello! I'm MPH's AI assistant. I can help you find your perfect car. What type of car are you looking for?")):(console.error("Failed to initialize chat: Invalid response"),k("assistant","I'm sorry, but I'm having trouble connecting to the server. Please try again later."))}catch(n){console.error("Error initializing chat:",n),k("assistant","I'm sorry, but I'm having trouble connecting to the server. Please try again later.")}}function k(e,t){const a=document.createElement("div");if(a.className=`mph-message mph-${e}-message`,a.innerHTML=t,n.animationsEnabled){const n="user"===e;a.style.opacity="0",a.style.transform=n?"translateX(20px)":"translateX(-20px)",a.style.transition="opacity 0.3s ease, transform 0.3s ease",c.appendChild(a),setTimeout((()=>{a.style.opacity="1",a.style.transform="translateX(0)"}),10)}else c.appendChild(a);c.scrollTop=c.scrollHeight,document.dispatchEvent(new CustomEvent("mph-message-added",{detail:{type:e,content:t}}))}async function E(t){if(t&&t.trim()){if(k("user",t),h&&(h.value=""),u||(u=!0,w=document.createElement("div"),w.className="mph-typing-indicator",w.innerHTML="<span></span><span></span><span></span>",c.appendChild(w),c.scrollTop=c.scrollHeight),!f)try{e("No context ID found, initializing chat before sending message"),await C()}catch(n){return console.error("Failed to initialize chat before sending message:",n),v(),void k("assistant","I'm having trouble connecting to our servers. Please try again in a moment.")}try{e(`Sending message to API with contextId: ${f}`);const a=await fetch(`${n.apiUrl}/api/chat/message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t,contextId:f})});if(v(),!a.ok)throw console.error(`API error: ${a.status}`,a),new Error(`API error: ${a.status}`);const o=await a.json();if(e("Response received:",o),!o||"object"!=typeof o)throw new Error("Invalid response data from API");if(o.success)if(o.message&&"string"==typeof o.message?k("assistant",o.message):e("Response missing message field or message is not a string"),o.cars&&Array.isArray(o.cars)){const t=o.cars.filter((n=>n&&"object"==typeof n?!(!n.make||!n.model||"number"!=typeof n.year||"number"!=typeof n.price)||(console.warn("Filtering out car with missing required properties:",n),!1):(console.warn("Filtering out invalid car (not an object):",n),!1)));if(e(`Filtered ${o.cars.length} cars down to ${t.length} valid cars`),t.length>0){e("Displaying car results:",t.length);const a=document.createElement("div");a.className="mph-cars-container",c.appendChild(a),t.forEach(((t,o)=>{try{e(`Processing car ${o}:`,t.id,t.make,t.model);const i=function(t,a){if(!t||"object"!=typeof t)return console.error("Invalid car data: not an object",t),null;try{e("Adding car result:",t);const o=document.createElement("div");o.className="mph-car-result";const i={id:t.id||`car-${Math.random().toString(36).substr(2,9)}`,year:t.year||"N/A",make:t.make||"Unknown Make",model:t.model||"Unknown Model",trim:t.trim||"",price:"number"==typeof t.price?t.price:0,mileage:"number"==typeof t.mileage?t.mileage:0,location:t.location||"Location unavailable",detailUrl:t.detailUrl||"#",imageUrl:t.imageUrl||"",bodyStyle:t.bodyStyle||"",transmission:t.transmission||"",exteriorColor:t.exteriorColor||"",interiorColor:t.interiorColor||"",condition:t.condition||""},r=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(i.price),s=new Intl.NumberFormat("en-US").format(i.mileage);[i.bodyStyle,i.transmission,i.exteriorColor&&`Ext: ${i.exteriorColor}`,i.interiorColor&&`Int: ${i.interiorColor}`].filter(Boolean).join(" • ");let l="";i.imageUrl&&(l=`\n            <div class="mph-car-result-image">\n              <img src="${i.imageUrl}" alt="${i.year} ${i.make} ${i.model}" \n                   onerror="this.onerror=null; this.style.display='none'; this.parentNode.style.display='none';">\n            </div>\n          `);let d="";return i.detailUrl&&"#"!==i.detailUrl&&(d=`\n            <a class="mph-car-result-link" href="${i.detailUrl}" target="_blank">\n              Details <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>\n            </a>\n          `),o.innerHTML=`\n          <div class="mph-car-result-flex">\n            <div class="mph-car-result-content">\n              <div class="mph-car-result-header" title="${i.year} ${i.make} ${i.model}">${i.year} ${i.make} ${i.model}</div>\n              <div>\n                <span class="mph-car-result-price">${r}</span>\n                ${i.mileage>0?`<span class="mph-car-result-mileage">• ${s} mi</span>`:""}\n              </div>\n              <div class="mph-car-result-location" title="${i.location}">${i.location}</div>\n            </div>\n            ${l}\n          </div>\n          <div style="text-align: right; padding-right: 5px;">\n            ${d}\n          </div>\n        `,n.animationsEnabled?(o.style.opacity="0",o.style.transform="translateY(20px)",o.style.transition="opacity 0.4s ease, transform 0.4s ease",a?a.appendChild(o):c.appendChild(o),setTimeout((()=>{o.style.opacity="1",o.style.transform="translateY(0)"}),10)):a?a.appendChild(o):c.appendChild(o),o}catch(n){console.error("Error rendering car result:",n,t);const e=document.createElement("div");return e.className="mph-car-result mph-car-result-error",e.innerHTML='<div style="color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">Error displaying car details</div>',a?a.appendChild(e):c.appendChild(e),e}}(t,a);i&&e(`Successfully added car ${o} to DOM`)}catch(n){console.error("Error processing car result:",n,t)}})),function(){const n=c.querySelectorAll(".mph-assistant-message");if(n.length>0){n[n.length-1].scrollIntoView({behavior:"smooth",block:"start"})}else c.scrollTop=c.scrollHeight}()}else o.message&&e("No valid car results after filtering")}else o.message&&e("No car results in response");else k("assistant","I'm sorry, I couldn't process your request.")}catch(n){v(),console.error("Error sending message:",n),k("assistant","Sorry, there was an error communicating with the server. Please try again later.")}}else console.warn("Attempted to send empty message")}new Map;return i&&i.addEventListener("click",b),d.addEventListener("click",y),m.addEventListener("click",(()=>{E(h.value)})),h.addEventListener("keypress",(n=>{"Enter"===n.key&&E(h.value)})),window.addEventListener("message",(t=>{if(n.allowedOrigins.length>0&&!n.allowedOrigins.includes(t.origin)&&!n.allowedOrigins.includes("*"))e("Message from disallowed origin:",t.origin);else if(t.data&&t.data.action)switch(t.data.action){case"mph-chat-open":x();break;case"mph-chat-close":y();break;case"mph-chat-toggle":b();break;case"mph-chat-send":t.data.message&&E(t.data.message)}})),document.addEventListener("mph-chat-open",x),document.addEventListener("mph-chat-close",y),document.addEventListener("mph-chat-toggle",b),document.addEventListener("mph-chat-send",(n=>{n.detail&&n.detail.message&&E(n.detail.message)})),window.mphChatWidget={open:x,close:y,toggle:b,isOpen:()=>g,sendMessage:E},e("Widget initialized with API URL:",n.apiUrl),{openChat:x,closeChat:y,toggleChat:b,isOpen:()=>g,sendMessage:E}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",o):o()}();